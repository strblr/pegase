
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An inline, fast, powerful and lightweight PEG parser generator for JavaScript and TypeScript, with semantic actions, parametrized rules, support for native regexps, error recovery, warnings, integrated AST generation and visitors, cut operator, back references, grammar merging, and a lot more.">
      
      
      
      
        <link rel="canonical" href="https://ostrebler.github.io/pegase/advanced-concepts/AST-and-visitors/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.8">
    
    
      
        <title>AST and visitors - Pegase</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.92558b1b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Inter";--md-code-font-family:""}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/nord.min.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
    
      <link rel="stylesheet" href="../../css/style.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Pegase" class="md-header__button md-logo" aria-label="Pegase" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Pegase
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              AST and visitors
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/ostrebler/pegase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"/></svg>
  </div>
  <div class="md-source__repository">
    pegase
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Pegase" class="md-nav__button md-logo" aria-label="Pegase" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    Pegase
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ostrebler/pegase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"/></svg>
  </div>
  <div class="md-source__repository">
    pegase
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Quick-start/" class="md-nav__link">
        Quick start
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Basic concepts
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Basic concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Building-parsers/" class="md-nav__link">
        Building parsers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Semantic-action-and-dataflow/" class="md-nav__link">
        Semantic action and dataflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Handling-whitespaces/" class="md-nav__link">
        Handling whitespaces
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Tokens/" class="md-nav__link">
        Tokens
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Directives/" class="md-nav__link">
        Directives
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../basic-concepts/Failures-and-warnings/" class="md-nav__link">
        Failures and warnings
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        Advanced concepts
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Advanced concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Advanced concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Parametrized-rules/" class="md-nav__link">
        Parametrized rules
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        AST and visitors
      </a>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Working-with-RegExp/" class="md-nav__link">
        Working with RegExp
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Cut-operator/" class="md-nav__link">
        Cut operator
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Debugging-with-tracers/" class="md-nav__link">
        Debugging with tracers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Using-TypeScript/" class="md-nav__link">
        Using TypeScript
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Error-recovery/" class="md-nav__link">
        Error recovery
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Grammar-fragments/" class="md-nav__link">
        Grammar fragments
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Writing-a-plugin/" class="md-nav__link">
        Writing a plugin
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Writing-a-Parser-subclass/" class="md-nav__link">
        Writing a Parser subclass
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../L-attributed-grammars/" class="md-nav__link">
        L-attributed grammars
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        API
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/peg-createTag/" class="md-nav__link">
        peg, createTag
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Parser/" class="md-nav__link">
        Parser
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/defaultPlugin/" class="md-nav__link">
        defaultPlugin
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Hooks/" class="md-nav__link">
        Hooks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Utility-functions/" class="md-nav__link">
        Utility functions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Types/" class="md-nav__link">
        Types
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../api/Metagrammar/" class="md-nav__link">
        Metagrammar
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        More
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="More" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          More
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../more/Ideas/" class="md-nav__link">
        Ideas
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../more/Bug-report-and-discussion/" class="md-nav__link">
        Bug report and discussion
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>AST and visitors</h1>
                
                <p>We saw in <a href="/pegase/basic-concepts/Semantic-action-and-dataflow/">Basic concepts &gt; Semantic actions and dataflow</a> that a parsing process can be represented as an invocation tree, called <em>concrete syntax tree</em>. This tree doesn't actually exist except temporarily in the JS call stack, thus semantic processes you want to fire at some "nodes" have to be executed at parse time. This is what semantic actions are for. You can do a lot with that, but it might not always be sufficient nor practical. For example, most real-life compilers do several traversals of the syntax tree, some dependent on the previous ones, with a clear separation of concerns. For the tree to be traversed multiple times, it has to be <strong>generated</strong> and <strong>kept</strong> in memory. You generally don't want to generate the whole concrete syntax tree which might have lots of parts only relevant to the syntax analysis but irrelevant in later stages. The actual tree you care about has custom nodes and is called <em>abstract syntax tree</em>.</p>
<p><strong>Pegase provides a clean and elegant way to generate ASTs: the <code>$node</code> hook.</strong></p>
<p>This hook can be called from semantic actions and has the following signature:</p>
<pre><code class="language-ts">(label: string, fields: Record&lt;string, any&gt;) =&gt; Node
</code></pre>
<p>Given a label to distinguish between node types and some custom fields, it builds and returns a <code>Node</code> object with the following signature:</p>
<pre><code class="language-ts">type Node = {
  $label: string;
  $from: Location;
  $to: Location;
  [field: string]: any;
}
</code></pre>
<p>The <code>$label</code> field and the custom fields simply correspond to <code>$node</code>'s arguments. The <code>$from</code> and <code>$to</code> keys are <em>automatically</em> set and indicate the boundaries of the match where the node was produced.</p>
<p><strong>Nodes can then be emitted, propagated and captured during the parsing process just like any <code>children</code>.</strong></p>
<p>The specifics of how this happens is totally up to you (see <a href="/pegase/basic-concepts/Semantic-action-and-dataflow/">Basic concepts &gt; Semantic actions and dataflow</a>). Here is an example of a grammar generating an AST for sums written in prefix notation:</p>
<pre><code class="language-ts">const prefix = peg`
  expr:
  | &lt;&gt;$integer ${({ $integer }) =&gt; $node(&quot;INT&quot;, { $integer })}
  | '+' &lt;a&gt;expr &lt;b&gt;expr ${({ a, b }) =&gt; $node(&quot;PLUS&quot;, { a, b })}

  $integer @raw: \d+
`;

const ast = prefix.value(&quot;+ 12 + 42 3&quot;);
</code></pre>
<p>The resulting <code>ast</code> will look like this:</p>
<p><img alt="AST" src="/pegase/assets/images/ast-1.png" /></p>
<p>You may have noticed that the custom node fields are the captures. This is actually a very common practice and Pegase offers a shortcut for it: the standard <code>@node</code> directive. This directive takes the node label as an argument, and automatically emits a <code>Node</code> whose custom fields <em>are</em> the captures. In other words, the following is <em>strictly equivalent</em> to the previous example:</p>
<pre><code class="language-ts">const prefix = peg`
  expr:
  | &lt;&gt;$integer @node('INT')
  | '+' &lt;a&gt;expr &lt;b&gt;expr @node('PLUS')

  $integer @raw: \d+
`;
</code></pre>
<p>But it gets even better. Just like <code>$</code> rules are syntactic sugar for <code>@token</code> rules, the <code>=&gt;</code> operator is syntactic sugar for the <code>@node</code> directive:</p>
<pre><code class="language-ts">const prefix = peg`
  expr:
  | &lt;&gt;$integer =&gt; 'INT'
  | '+' &lt;a&gt;expr &lt;b&gt;expr =&gt; 'PLUS'

  $integer @raw: \d+
`;
</code></pre>
<p>What if you still want to tweak some fields before setting up the <code>Node</code> ? Well, the <code>@node</code> directive can take as a second argument a function that maps the captures to custom fields. These fields will be merged to the existing captures and the result will be set as the <code>Node</code>'s custom fields. It gives you the flexibility of an explicit call to the <code>$node</code> hook, with the brevity and expressivity of the directive.</p>
<p>To illustrate that, let's parse complex numbers written in the form <em>"a + bi"</em>. The imaginary part is optional, so the <code>i</code> capture may be <code>undefined</code>. If that's indeed the case, we want our <code>i</code> node field to default to zero:</p>
<pre><code class="language-ts">const complex = peg`
  complex:
    &lt;r&gt;$num &lt;i&gt;('+' $num 'i')?
      @node('COMPLEX', ${({ i }) =&gt; ({ i: i || 0 })})

  $num @number: \d+
`;

complex.value(&quot;13+6i&quot;); // { $label: &quot;COMPLEX&quot;, $from: (...), $to: (...), r: 13, i: 6 }
complex.value(&quot;42&quot;);    // { $label: &quot;COMPLEX&quot;, $from: (...), $to: (...), r: 42, i: 0 }
</code></pre>
<p>Once an AST is generated, the next step is obviously to implement traversal procedures. The possibilities are nearly infinite: performing semantic checks (like type checks), fine-tuning a syntactic analysis, mutating the tree (like <a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md">Babel plugins</a>), folding the tree to some output value, etc. To implement traversals of ASTs, Pegase ships with its own <a href="https://en.wikipedia.org/wiki/Visitor_pattern#Use_case_example">visitor pattern</a>.</p>
<p><strong>A Pegase visitor is an object whose keys are node labels and whose values are callbacks taking a <code>Node</code> as single argument:</strong></p>
<pre><code class="language-ts">type Visitor = {
  [label: string]: (node: Node) =&gt; any
}
</code></pre>
<p>The <em>result</em> of a visitor for a given node <code>n</code> is the return value of the callback associated with the label of <code>n</code>. Visitors are directly passed via the <code>visit</code> option to a parser's <code>parse</code>, <code>test</code>, <code>value</code> or <code>children</code> method, either as a single visitor or as an array of visitors forming a visitor pipe.</p>
<p><strong>After the parsing is done, the final <code>children</code> array will be mapped through the visitor pipe.</strong></p>
<p>Every <code>children</code> item will individually be sent down the visitor pipe. Each visitor feeds its result to next one. The result of the final visitor will replace the initial child. This mechanism implies two things:</p>
<ul>
<li><code>children</code> never changes size as a result of visits, it's just a one-to-one mapping. Thus parsers who produce a <code>value</code> (ie. a single child) keep producing a <code>value</code> no matter how many visitors you stack. The final <code>value</code> will be the result of the visitor pipe applied to the initial <code>value</code>.</li>
<li>Only the last visitor can return a non-<code>Node</code> result, since each visitor has to be fed with a <code>Node</code> value.</li>
</ul>
<p><img alt="AST" src="/pegase/assets/images/ast-2.png" /></p>
<p>Let's build a simple visitor that transforms the output <code>Node</code> of our previous <code>prefix</code> grammar into its label:</p>
<pre><code class="language-ts">const prefix = peg`
  expr:
  | &lt;&gt;$integer =&gt; 'INT'
  | '+' &lt;a&gt;expr &lt;b&gt;expr =&gt; 'PLUS'

  $integer @raw: \d+
`;

const labelVisitor = {
  INT: node =&gt; node.$label,
  PLUS: node =&gt; node.$label
};

prefix.value(&quot;182&quot;, { visit: labelVisitor });         // &quot;INT&quot;
prefix.value(&quot;+ 12 + 42 3&quot;, { visit: labelVisitor }); // &quot;PLUS&quot;
</code></pre>
<p>As you might have spotted, the <code>INT</code> and <code>PLUS</code> callbacks are exactly the same. You can replace them with a simple default case callback by using the <code>$default</code> key. This callback will be called when no other visitor key matches the current node label.</p>
<pre><code class="language-ts">const labelVisitor = {
  $default: node =&gt; node.$label
};
</code></pre>
<p>Let's dive a bit deeper: how would you implement a visitor that calculates the sum's result ? Calculating a sum from an AST means <a href="https://en.wikipedia.org/wiki/Fold_(higher-order_function)"><em>folding</em></a> the AST into a single value, which implies recursive visits to child nodes. That's exactly what the <code>$visit</code> hook is for: called from <em>inside</em> a visitor callback and given a node, it applies the current visitor to that node and returns the result. Our sum visitor could be implemented as follows:</p>
<pre><code class="language-ts">const sumVisitor = {
  INT: node =&gt; Number(node.$integer),
  PLUS: node =&gt; $visit(node.a) + $visit(node.b)
};

prefix.value(&quot;182&quot;, { visit: sumVisitor });         // 182
prefix.value(&quot;+ 12 + 42 3&quot;, { visit: sumVisitor }); // 57
</code></pre>
<p>Next, to illustrate visitor piping, we're going to add a visitor right before <code>sumVisitor</code> that preserves the AST but <em>doubles</em> the <code>$integer</code> value of <code>INT</code> nodes. This basically implies that each visitor callback will have to be an identity function, returning the node it was passed and only performing side-effects. For <code>INT</code> nodes, the side-effect is to double the value. For <code>PLUS</code> nodes, it's to visit the child nodes. Giving us:</p>
<pre><code class="language-ts">const doubleVisitor = {
  INT: node =&gt; {
    node.$integer *= 2;
    return node;
  },
  PLUS: node =&gt; {
    $visit(node.a);
    $visit(node.b);
    return node;
  }
};

prefix.value(&quot;182&quot;, { visit: [doubleVisitor, sumVisitor] });         // 364
prefix.value(&quot;+ 12 + 42 3&quot;, { visit: [doubleVisitor, sumVisitor] }); // 114
</code></pre>
<p>You get the idea. Have fun !</p>
<p><strong>A visitor callback has access to all the hooks available in semantic actions</strong>, except <code>$children</code>, <code>$value</code>, <code>$commit</code> and <code>$emit</code>. So it's totally fine to emit warnings and failures from visitors:</p>
<pre><code class="language-ts">const sumVisitor = {
  INT: node =&gt; {
    if (node.$integer === &quot;42&quot;) $warn(&quot;42 is too powerful&quot;);
    return Number(node.$integer);
  },
  PLUS: node =&gt; $visit(node.a) + $visit(node.b)
};
</code></pre>
<p><strong><code>prefix.parse("+ 12 + 42 3", { visit: sumVisitor }).logger.toString()</code></strong></p>
<pre><code class="language-text">(1:8) Warning: 42 is too powerful

&gt; 1 | + 12 + 42 3
    |        ^
</code></pre>
<p>The effect of some hooks differs when used in a semantic action vs. a visitor. In semantic actions, <code>$fail</code> and <code>$expected</code> don't commit failures, they emit failure <em>candidates</em> which are then merged or filtered out using the farthest failure heuristic (see <a href="/pegase/basic-concepts/Failures-and-warnings">Basic concepts &gt; Failures and warnings</a>). In visitors, these hooks commit failures directly. The heuristic wouldn't make much sense outside of a backtracking syntactic analysis. Please refer to <a href="/pegase/api/Hooks/">API &gt; Hooks</a> for an exhaustive doc of all hooks.</p>
<p>If you need to separate the parsing and the visits (for example to pass different contexts to different visitors), you can make an explicit call to the <code>applyVisitor</code> utility function:</p>
<pre><code class="language-ts">const result = prefix.parse(&quot;+ 12 + 42 3&quot;);
if(result.success) {
  result.options.context = newContext; // Changing context
  const value = applyVisitor(result.value, sumVisitor, result.options); // Explicit visit
  // ...
}
</code></pre>
<p>See <a href="/pegase/api/Utility-functions/">API &gt; Utility functions</a>.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Parametrized-rules/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Parametrized rules" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Parametrized rules
            </div>
          </div>
        </a>
      
      
        
        <a href="../Working-with-RegExp/" class="md-footer__link md-footer__link--next" aria-label="Next: Working with RegExp" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Working with RegExp
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © ostrebler
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/ostrebler/pegase" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.94ec81fe.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.48dfec6c.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
      
        <script src="https://unpkg.com/pegase@0.5.3/umd/index.js"></script>
      
        <script src="../../javascript/config.js"></script>
      
    
  </body>
</html>